#sub_path_only rewrite ^__PATH__$ __PATH__/ permanent;
location __PATH__/ {

  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header X-Forwarded-For $remote_addr;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  # Path to source
  alias __INSTALL_DIR__/public/;

  index index.php;

  client_max_body_size 50M;

  # InvoiceShelf's default config, for reference:
  # https://github.com/InvoiceShelf/docker/blob/master/default.conf

  # serve static files directly
  location ~* \.(jpg|jpeg|gif|css|png|js|ico|html)$ {
    access_log off;
    expires max;
    log_not_found off;
  }

  # removes trailing slashes (prevents SEO duplicate content issues)
  if (!-d $request_filename) {
    rewrite ^/(.+)/$ /$1 permanent;
  }

  # If the request is not for a valid file (image, js, css, etc.), send to bootstrap
  if (!-e $request_filename) {
    rewrite ^/(.*)$ /index.php?/$1 last;
    break;
  }

  try_files $uri $uri/ /index.php?$query_string;
  location ~ [^/]\.php(/|$) {
    fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    fastcgi_pass unix:/var/run/php/php__PHP_VERSION__-fpm-__APP__.sock;

    fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_param REMOTE_USER $remote_user;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param SCRIPT_FILENAME $request_filename;
  }

  # Deny access to other .php files, rather than exposing their contents
  location ~ [^/]\.php(/|$) {
    return 403;
  }

}
